<!DOCTYPE html>
<html>
    <head>
        <title>WebGL</title>
        <style type='text/css'>
            body {
                margin: 0;
                padding: 0;
            }
            canvas {
                display: block;
                margin: 0 auto 0 auto;
            }
        </style>
        <script type="text/javascript" src='js/glMatrix-0.9.5.min.js'></script>
        <script type="text/javascript" src='js/webgl-utils.js'></script>
        <script type="text/javascript" src='js/network.js'></script>
    </head>
    <body>
        <canvas width='500' height='500' id='canvas' ></canvas>
        <script type='text/javascript'>
            var gl, canvas, shaderProgram;
            var vertexShader, fragmentShader;
            var move = mat4.create(), project = mat4.create();
            var vertexBuffer, vertexColorBuffer, indexBuffer;
            var theta = 0, lastTime = 0;
            var mvMatrixStack = [];
            function tick() {
                requestAnimFrame( tick );
                drawScene();
                animate();
            }
            function animate() {
                var timeNow = new Date().getTime();
                if ( lastTime != 0 ) {
                    var elapsed = timeNow - lastTime;

                    theta += ( 75 * elapsed ) / 1000.0;
                }
                lastTime = timeNow;
            }
            function degToRad( degrees ) {
                return degrees * Math.PI / 180;
            }
            function mvPushMatrix() {
                var copy = mat4.create();
                mat4.set( move, copy );
                mvMatrixStack.push( copy );
            }

            function mvPopMatrix() {
                if ( mvMatrixStack.length == 0 ) {
                    throw "Invalid popMatrix!";
                }
                move = mvMatrixStack.pop();
            }
            function webGLStart() {
                canvas = document.getElementById( 'canvas' );
                gl = canvas.getContext( 'experimental-webgl' );
                gl.viewportWidth = canvas.width;
                gl.viewportHeight = canvas.height;
                getShaders( 'vertex.c', 'fragment.c' );
            }
            function startRender() {
                initBuffer();
                gl.clearColor( 1.0, 1.0, 1.0, 1.0 );
                gl.enable( gl.DEPTH_TEST );
                tick();
            }
            function initShaders( vertexShader, fragmentShader ) {
                shaderProgram = gl.createProgram();

                gl.attachShader( shaderProgram, vertexShader );
                gl.attachShader( shaderProgram, fragmentShader );

                gl.linkProgram( shaderProgram );

                gl.useProgram( shaderProgram );

                shaderProgram.position = gl.getAttribLocation( shaderProgram, 'position' );
                gl.enableVertexAttribArray( shaderProgram.position );

                shaderProgram.color = gl.getAttribLocation( shaderProgram, 'color' );
                gl.enableVertexAttribArray( shaderProgram.color );

                shaderProgram.project = gl.getUniformLocation( shaderProgram, 'project' );
                shaderProgram.move = gl.getUniformLocation( shaderProgram, 'move' );

                startRender();
            }
            function setMatrixUniform() {
                gl.uniformMatrix4fv( shaderProgram.project, false, project ); 
                gl.uniformMatrix4fv( shaderProgram.move, false, move ); 
            }
            function getShaders( vertexShaderSrc, fragmentShaderSrc ) {
                wget( vertexShaderSrc, function( vertexSrc ) {
                    wget( fragmentShaderSrc, function( fragmentSrc ) {
                        fragmentShader = gl.createShader( gl.FRAGMENT_SHADER );
                        vertexShader = gl.createShader( gl.VERTEX_SHADER );

                        gl.shaderSource( vertexShader, vertexSrc );
                        gl.compileShader( vertexShader );
                        gl.shaderSource( fragmentShader, fragmentSrc );
                        gl.compileShader( fragmentShader );

                        initShaders( vertexShader, fragmentShader );
                    } );
                } );
            }
            function initBuffer() {
                var vertices = [
                  // Front face
                  -1.0, -1.0,  1.0,
                   1.0, -1.0,  1.0,
                   1.0,  1.0,  1.0,
                  -1.0,  1.0,  1.0,

                  // Back face
                  -1.0, -1.0, -1.0,
                  -1.0,  1.0, -1.0,
                   1.0,  1.0, -1.0,
                   1.0, -1.0, -1.0,

                  // Top face
                  -1.0,  1.0, -1.0,
                  -1.0,  1.0,  1.0,
                   1.0,  1.0,  1.0,
                   1.0,  1.0, -1.0,

                  // Bottom face
                  -1.0, -1.0, -1.0,
                   1.0, -1.0, -1.0,
                   1.0, -1.0,  1.0,
                  -1.0, -1.0,  1.0,

                  // Right face
                   1.0, -1.0, -1.0,
                   1.0,  1.0, -1.0,
                   1.0,  1.0,  1.0,
                   1.0, -1.0,  1.0,

                  // Left face
                  -1.0, -1.0, -1.0,
                  -1.0, -1.0,  1.0,
                  -1.0,  1.0,  1.0,
                  -1.0,  1.0, -1.0,
                ];
                var indices = [
                    0, 1, 2,      0, 2, 3,    // Front face
                    4, 5, 6,      4, 6, 7,    // Back face
                    8, 9, 10,     8, 10, 11,  // Top face
                    12, 13, 14,   12, 14, 15, // Bottom face
                    16, 17, 18,   16, 18, 19, // Right face
                    20, 21, 22,   20, 22, 23  // Left face
                ];
                var colors = [
                  [1.0, 0.0, 0.0, 1.0],     // Front face
                  [1.0, 1.0, 0.0, 1.0],     // Back face
                  [0.0, 1.0, 0.0, 1.0],     // Top face
                  [1.0, 0.5, 0.5, 1.0],     // Bottom face
                  [1.0, 0.0, 1.0, 1.0],     // Right face
                  [0.0, 0.0, 1.0, 1.0],     // Left face
                ];
                var unpackedColors = [];
                for ( var i in colors ) {
                    var color = colors[ i ];
                    for ( var j = 0; j < 4; j++ ) {
                        unpackedColors = unpackedColors.concat(color);
                    }
                }
                vertexBuffer = gl.createBuffer();
                gl.bindBuffer( gl.ARRAY_BUFFER, vertexBuffer );
                gl.bufferData( gl.ARRAY_BUFFER, new Float32Array( vertices ), gl.STATIC_DRAW );
                vertexBuffer.itemSize = 3;
                vertexBuffer.numItems = 24;

                vertexColorBuffer = gl.createBuffer();
                gl.bindBuffer( gl.ARRAY_BUFFER, vertexColorBuffer );
                gl.bufferData( gl.ARRAY_BUFFER, new Float32Array( unpackedColors ), gl.STATIC_DRAW );
                vertexColorBuffer.itemSize = 4;
                vertexColorBuffer.numItems = 24;

                indexBuffer = gl.createBuffer(); 
                gl.bindBuffer( gl.ELEMENT_ARRAY_BUFFER, indexBuffer );
                gl.bufferData( gl.ELEMENT_ARRAY_BUFFER, new Uint16Array( indices ), gl.STATIC_DRAW );
                indexBuffer.itemSize = 1;
                indexBuffer.numItems = 36;
            }
            function drawScene() {
                gl.viewport( 0, 0, gl.viewportWidth, gl.viewportHeight );
                gl.clear( gl.COLOR_BUFFER_BIT | gl.BUFFER_BIT );

                mat4.perspective( 45, gl.viewportWidth / gl.viewportHeight, 0.1, 100.0, project );

                mat4.identity( move );

                mat4.translate( move, [0.0, 0.0, -5.0] );
                mvPushMatrix();
                mat4.rotate( move, degToRad( theta ), [1, 1, 0] );

                gl.bindBuffer( gl.ARRAY_BUFFER, vertexBuffer );
                gl.vertexAttribPointer( shaderProgram.position, vertexBuffer.itemSize, gl.FLOAT, false, 0, 0 );
   
                gl.bindBuffer( gl.ARRAY_BUFFER, vertexColorBuffer );
                gl.vertexAttribPointer( shaderProgram.color, vertexColorBuffer.itemSize, gl.FLOAT, false, 0, 0 );
        
                gl.bindBuffer( gl.ELEMENT_ARRAY_BUFFER, indexBuffer );
                setMatrixUniform();
                gl.drawElements( gl.TRIANGLES, indexBuffer.numItems, gl.UNSIGNED_SHORT, 0 );

                mvPopMatrix();
            }
            webGLStart();
        </script>
    </body>
</html>
